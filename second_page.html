<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify API Mood Search</title>
    <link rel="stylesheet" href="second_page.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<h1>Spotify API Mood Search</h1>

<div class="image-container">
    <img src="happy.png" alt="Happy" class="mood-image" onclick="searchSongs('happy')">
    <img src="sad.png" alt="Sad" class="mood-image" onclick="searchSongs('sad')">
    <img src="disgust.png" alt="Disgust" class="mood-image" onclick="searchSongs('disgust')">
    <img src="fear.png" alt="Fear" class="mood-image" onclick="searchSongs('fear')">
    <img src="anger.png" alt="Anger" class="mood-image" onclick="searchSongs('anger')">
</div>

<div id="results-container">
    <div id="results"></div>
</div>

<button id="logout-button">Logout</button>

<script>
$(document).ready(function() {
    // Attach event listener to logout button
    $("#logout-button").click(function() {
        // Redirect to index.html
        window.location.href = "https://scripteds.github.io/MoodSwinger/index.html";
    });

    // Retrieve stored search results and selected mood from sessionStorage
    const storedResults = sessionStorage.getItem('searchResults');
    const selectedMood = sessionStorage.getItem('selectedMood');

    if (storedResults && selectedMood) {
        $('#results').html(storedResults);
    }

    // Retrieve access token from sessionStorage
    const accessToken = sessionStorage.getItem('accessToken');

    if (accessToken) {
        // Fetch user info from Spotify API using the access token
        $.ajax({
            url: "https://api.spotify.com/v1/me",
            type: "GET",
            headers: {
                "Authorization": "Bearer " + accessToken
            },
            success: function(response) {
                const spotifyUsername = response.display_name;
                const spotifyUserId = response.id;
                // Display Spotify user info
                console.log("Spotify Username:", spotifyUsername);
                console.log("Spotify User ID:", spotifyUserId);
            },
            error: function(xhr, status, error) {
                console.log("Error fetching user info:", error);
            }
        });
    } else {
        console.log("Access token not found in sessionStorage.");
    }
});

function searchSongs(mood) {
    // Map moods to Spotify seed genres
    var moodToGenre = {
        'happy': 'happy',
        'sad': 'sad',
        'disgust': 'alternative',
        'fear': 'ambient',
        'anger': 'metal'
    };

    var selectedGenre = moodToGenre[mood];

    // Store selected mood in sessionStorage
    sessionStorage.setItem('selectedMood', selectedGenre);

    // Client ID and Client Secret
    var clientId = "a80fcf0c3aae4aabb6f6b6721183b72e";
    var clientSecret = "d786a136f1714d3f98a1adeb0a5f6c09";

    // Request access token
    $.ajax({
        url: "https://accounts.spotify.com/api/token",
        type: "POST",
        headers: {
            "Authorization": "Basic " + btoa(clientId + ":" + clientSecret)
        },
        data: {
            "grant_type": "client_credentials"
        },
        success: function(response) {
            var accessToken = response.access_token;
            searchRecommendedTracks(selectedGenre, accessToken);
        },
        error: function(xhr, status, error) {
            console.log(error);
        }
    });
}
  
function searchRecommendedTracks(mood, accessToken) {
    // Use Spotify's recommendation API to get recommended tracks based on mood
    var apiUrl = "https://api.spotify.com/v1/recommendations?seed_genres=" + mood + "&limit=5";

    if (!accessToken) {
        console.log("Access token not available.");
        return;
    }

    $.ajax({
        url: apiUrl,
        type: "GET",
        headers: {
            "Authorization": "Bearer " + accessToken
        },
        success: function(response) {
            if (response && response.tracks) {
                createPlaylistAndAddTracks(response.tracks);
            } else {
                console.error("Error: Invalid response from Spotify API");
            }
        },
        error: function(xhr, status, error) {
            console.log(error);
        }
    });
}

function createPlaylistAndAddTracks(tracks) {
    var playlistName = "New Playlist";
    var accessToken = sessionStorage.getItem('accessToken');

    // Check if access token is available
    if (!accessToken) {
        console.log("Access token not found.");
        return;
    }

    $.ajax({
        url: "https://api.spotify.com/v1/me/playlists",
        type: "POST",
        headers: {
            "Authorization": "Bearer " + accessToken,
            "Content-Type": "application/json"
        },
        data: JSON.stringify({
            "name": playlistName,
            "public": false, // Change to true if you want it to be public
            "description": "New playlist description"
        }),
        success: function(playlistResponse) {
            var playlistId = playlistResponse.id;
            var trackUris = tracks.map(track => "spotify:track:" + track.id);

            // Add tracks to the created playlist
            $.ajax({
                url: "https://api.spotify.com/v1/playlists/" + playlistId + "/tracks",
                type: "POST",
                headers: {
                    "Authorization": "Bearer " + accessToken,
                    "Content-Type": "application/json"
                },
                data: JSON.stringify({
                    "uris": trackUris
                }),
                success: function(response) {
                    console.log("Playlist created and tracks added successfully!");
                },
                error: function(xhr, status, error) {
                    console.log("Error adding tracks to playlist:", error);
                }
            });
        },
        error: function(xhr, status, error) {
            console.log("Error creating playlist:", error);
        }
    });
}



function displayResults(data) {
    var tracks = data.tracks;
    var html = "<h2>Recommended Tracks</h2>";
    html += "<div class='tracks'>";
    var count = 0;
    for (var i = 0; i < tracks.length && count < 5; i++) {
        var trackName = tracks[i].name;
        var trackId = tracks[i].id;
        var artistName = tracks[i].artists[0].name;
        var releaseYear = new Date(tracks[i].album.release_date).getFullYear();
        var previewUrl = tracks[i].preview_url;
        var spotifyUrl = "https://open.spotify.com/track/" + trackId;
        if (previewUrl) {
            html += "<div class='track'>";
            html += '<p><a href="https://scripteds.github.io/MoodSwinger/track.html" onclick="saveTrackDetails(\'' + trackId + '\', \'' + trackName + '\', \'' + artistName + '\', \'' + releaseYear + '\')">' + trackName + '</a></p>';
            html += '<iframe src="https://open.spotify.com/embed/track/' + trackId + '" width="400" height="100" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>';
            html += '<a href="' + spotifyUrl + '" target="_blank">Listen on Spotify</a>';
            html += "</div>";
            count++;
        }
    }
    html += "</div>";
    $("#results").html(html);

    // Store search results in sessionStorage
    sessionStorage.setItem('searchResults', html);
}

function saveTrackDetails(trackId, trackName, artistName, releaseYear) {
    sessionStorage.setItem('trackId', trackId);
    sessionStorage.setItem('trackName', trackName);
    sessionStorage.setItem('artistName', artistName);
    sessionStorage.setItem('releaseYear', releaseYear);
}
</script>

</body>
</html>
