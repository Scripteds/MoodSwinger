$(document).ready(function() {
  // Attach event listener to logout button
  $("#logout-button").click(function() {
    // Redirect to index.html
    window.location.href = "https://scripteds.github.io/MoodSwinger/index.html";
  });

  // Retrieve stored search results and selected mood from sessionStorage
  const storedResults = sessionStorage.getItem('searchResults');
  const selectedMood = sessionStorage.getItem('selectedMood');

  if (storedResults && selectedMood) {
    $('#moods').val(selectedMood);
    $('#results').html(storedResults);
  }
});

function searchSongs() {
  var selectedMood = $("#moods").val();
  if (selectedMood == "0") {
    alert("Please select a mood.");
    return;
  }

  // Store selected mood in sessionStorage
  sessionStorage.setItem('selectedMood', selectedMood);

  // Client ID and Client Secret
  var clientId = "a80fcf0c3aae4aabb6f6b6721183b72e";
  var clientSecret = "d786a136f1714d3f98a1adeb0a5f6c09";

  // Request access token
  $.ajax({
    url: "https://accounts.spotify.com/api/token",
    type: "POST",
    headers: {
      "Authorization": "Basic " + btoa(clientId + ":" + clientSecret)
    },
    data: {
      "grant_type": "client_credentials"
    },
    success: function(response) {
      var accessToken = response.access_token;
      searchRecommendedTracks(selectedMood, accessToken);
    },
    error: function(xhr, status, error) {
      console.log(error);
    }
  });
}

function searchRecommendedTracks(mood, accessToken) {
  // Use Spotify's recommendation API to get recommended tracks based on mood
  var apiUrl = "https://api.spotify.com/v1/recommendations?seed_genres=" + mood + "&limit=50";

  if (!accessToken) {
    console.log("Access token not available.");
    return;
  }

  $.ajax({
    url: apiUrl,
    type: "GET",
    headers: {
      "Authorization": "Bearer " + accessToken
    },
    success: function(response) {
      displayResults(response, accessToken);
    },
    error: function(xhr, status, error) {
      console.log(error);
    }
  });
}

function displayResults(data, accessToken) {
  var tracks = data.tracks;
  var html = "<h2>Recommended Tracks</h2>";
  html += "<div class='tracks'>";
  var trackUris = [];
  for (var i = 0; i < tracks.length; i++) {
    var trackName = tracks[i].name;
    var trackId = tracks[i].id;
    var artistName = tracks[i].artists[0].name;
    var releaseYear = new Date(tracks[i].album.release_date).getFullYear();
    var previewUrl = tracks[i].preview_url;
    var spotifyUrl = "https://open.spotify.com/track/" + trackId;
    if (previewUrl) {
      trackUris.push('spotify:track:' + trackId);
      html += "<div class='track'>";
      html += '<p><a href="https://scripteds.github.io/MoodSwinger/track.html" onclick="saveTrackDetails(\'' + trackId + '\', \'' + trackName + '\', \'' + artistName + '\', \'' + releaseYear + '\')">' + trackName + '</a></p>';
      html += '<iframe src="https://open.spotify.com/embed/track/' + trackId + '" width="400" height="100" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>';
      html += '<a href="' + spotifyUrl + '" target="_blank">Listen on Spotify</a>';
      html += "</div>";
    }
  }
  html += "</div>";
  $("#results").html(html);

  // Store search results in sessionStorage
  sessionStorage.setItem('searchResults', html);

  // Create playlist and add tracks
  createPlaylistAndAddTracks(trackUris, accessToken);
}

function createPlaylistAndAddTracks(trackUris, accessToken) {
  // Get user ID
  $.ajax({
    url: "https://api.spotify.com/v1/me",
    type: "GET",
    headers: {
      "Authorization": "Bearer " + accessToken
    },
    success: function(response) {
      var userId = response.id;
      // Create playlist
      $.ajax({
        url: `https://api.spotify.com/v1/users/${userId}/playlists`,
        type: "POST",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        data: JSON.stringify({
          name: 'My Mood Playlist',
          public: true
        }),
        success: function(playlistResponse) {
          var playlistId = playlistResponse.id;
          // Add tracks to playlist
          $.ajax({
            url: `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
            type: "POST",
            headers: {
              "Authorization": "Bearer " + accessToken,
              "Content-Type": "application/json"
            },
            data: JSON.stringify({
              uris: trackUris
            }),
            success: function() {
              // Play the playlist
              playPlaylist(playlistId, accessToken);
            },
            error: function(xhr, status, error) {
              console.log(error);
            }
          });
        },
        error: function(xhr, status, error) {
          console.log(error);
        }
      });
    },
    error: function(xhr, status, error) {
      console.log(error);
    }
  });
}

function playPlaylist(playlistId, accessToken) {
  window.onSpotifyWebPlaybackSDKReady = () => {
    const player = new Spotify.Player({
      name: 'Web Playback SDK Player',
      getOAuthToken: cb => { cb(accessToken); }
    });

    // Error handling
    player.addListener('initialization_error', ({ message }) => { console.error(message); });
    player.addListener('authentication_error', ({ message }) => { console.error(message); });
    player.addListener('account_error', ({ message }) => { console.error(message); });
    player.addListener('playback_error', ({ message }) => { console.error(message); });

    // Playback status updates
    player.addListener('player_state_changed', state => { console.log(state); });

    // Ready
    player.addListener('ready', ({ device_id }) => {
      console.log('Ready with Device ID', device_id);

      // Transfer playback to the Web Playback SDK
      fetch('https://api.spotify.com/v1/me/player', {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          device_ids: [device_id],
          play: true
        })
      });

      // Start playback
      fetch(`https://api.spotify.com/v1/me/player/play`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          context_uri: `spotify:playlist:${playlistId}`
        })
      });
    });

    // Not Ready
    player.addListener('not_ready', ({ device_id }) => {
      console.log('Device ID has gone offline', device_id);
    });

    player.connect();
  };
}
